// Ключи и ответы для заданий
const CHALLENGES = {
    1: {
        answer: "СКРЫТОЕ",
        nextKey: "СКРЫТОЕ",
        description: "Найдите буквы в тексте по указанным позициям"
    },
    2: {
        answer: "KEY_STEG0_2",
        nextKey: "KEY_STEG0_2",
        description: "Расшифруйте шифр Цезаря"
    },
    3: {
        answer: "KEY_STEG0_3",
        nextKey: "KEY_STEG0_3",
        description: "Восстановите строку из ASCII кодов"
    },
    4: {
        answer: "KEY_STEG0_4",
        nextKey: "KEY_STEG0_4",
        description: "Комбинация техник"
    },
    5: {
        answer: "FLAG{ST3G4N0GR4PHY_MA5T3R_2024}",
        nextKey: null,
        description: "Финальный флаг"
    }
};

// Задание 1: Скрытие ключа в тексте через номера позиций
function generateTask1File() {
    const key = "СКРЫТОЕ";
    
    // Создаем текст, в котором гарантированно есть все символы ключа СКРЫТОЕ
    // Используем текст с русскими буквами
    const textWithKey = `В современном мире информационных технологий стеганография играет важную роль.
    Ключ к пониманию скрыт в этом тексте. Ежедневно мы используем различные способы передачи данных.
    Стеганография позволяет скрывать информацию в обычных файлах. Один из простых методов - это использование позиций букв.
    Для решения этой задачи нужно найти буквы по указанным номерам позиций в тексте.
    Стеганография отличается от криптографии способом защиты информации.
    Этот метод прост в использовании и не требует специальных инструментов.
    Практическое применение включает защиту авторских прав и безопасную передачу данных.
    Исследователи разрабатывают новые методы скрытия информации в различных форматах.
    Каждый может изучить основы стеганографии и применить их на практике.`;
    
    // Убираем все кроме букв (кириллица) и цифр для подсчета позиций
    const cleanText = textWithKey.replace(/[^А-Яа-я0-9]/g, '');
    
    // Находим реальные позиции символов ключа в тексте
    const realPositions = [];
    let searchIndex = 0;
    
    for (let i = 0; i < key.length; i++) {
        const char = key[i];
        // Ищем символ в тексте (начиная с последней найденной позиции)
        let found = false;
        for (let j = searchIndex; j < cleanText.length; j++) {
            if (cleanText[j].toUpperCase() === char.toUpperCase() || 
                cleanText[j] === char) {
                realPositions.push(j + 1); // Позиции начинаются с 1
                searchIndex = j + 1;
                found = true;
                break;
            }
        }
        if (!found) {
            // Если символ не найден, добавляем его в конец текста для гарантии
            realPositions.push(cleanText.length + 1);
        }
    }
    
    // Создаем финальный текст с инструкциями
    const finalText = `${textWithKey}

=== ЗАДАНИЕ ===
Найдите буквы в тексте выше по следующим позициям.
Позиции считаются с начала текста (пробелы и знаки препинания НЕ учитываются, только буквы и цифры):

${key.split('').map((char, i) => {
    const pos = realPositions[i];
    return `Позиция ${i + 1}: ${pos}`;
}).join('\n')}

Запишите найденные символы подряд - это и есть ключ к следующему заданию.
Ключ - это русское слово из 7 букв.`;
    
    return finalText;
}

// Задание 2: Шифр Цезаря
function generateTask2File() {
    const key = "KEY_STEG0_2";
    const shift = 3; // Сдвиг на 3 позиции
    
    // Шифруем ключ шифром Цезаря
    let encrypted = "";
    for (let char of key) {
        if (char === '_') {
            encrypted += '_';
        } else if (char >= '0' && char <= '9') {
            // Для цифр: сдвиг по модулю 10
            encrypted += String.fromCharCode(((char.charCodeAt(0) - 48 + shift) % 10) + 48);
        } else if (char >= 'A' && char <= 'Z') {
            // Для букв: сдвиг по модулю 26
            encrypted += String.fromCharCode(((char.charCodeAt(0) - 65 + shift) % 26) + 65);
        } else {
            encrypted += char;
        }
    }
    
    const content = `=== ЗАДАНИЕ 2 ===

Обнаружено зашифрованное сообщение, используя шифр Цезаря.

Зашифрованный текст: ${encrypted}

Инструкция:
1. Шифр Цезаря - это метод шифрования, где каждая буква сдвигается на определенное количество позиций в алфавите.
2. Цифры также сдвигаются (0-9).
3. Подчеркивание "_" остается без изменений.
4. Для расшифровки нужно сдвинуть символы в обратную сторону.

Подсказка: Сдвиг составляет 3 позиции вперед (A→D, B→E, ... Z→C, 0→3, 1→4, ... 9→2).
Для расшифровки сдвиньте каждый символ на 3 позиции НАЗАД.

Расшифруйте сообщение и введите ключ к следующему заданию.`;
    
    return content;
}

// Задание 3: ASCII коды
function generateTask3File() {
    const key = "KEY_STEG0_3";
    
    // Преобразуем ключ в ASCII коды
    const asciiCodes = [];
    for (let char of key) {
        asciiCodes.push(char.charCodeAt(0));
    }
    
    const content = `=== ЗАДАНИЕ 3 ===

Обнаружено сообщение, закодированное с помощью ASCII кодов.

ASCII коды (через запятую):
${asciiCodes.join(', ')}

Инструкция:
1. ASCII (American Standard Code for Information Interchange) - это стандарт кодирования символов.
2. Каждому символу соответствует числовой код.
3. Например: 'A' = 65, 'B' = 66, 'a' = 97, '0' = 48, '1' = 49, '_' = 95.

Справочная таблица (часть):
- Буквы A-Z: 65-90
- Буквы a-z: 97-122
- Цифры 0-9: 48-57
- Символ _: 95

Подсказка: Преобразуйте каждое число в соответствующий символ ASCII.
Используйте функцию chr() в Python или просто найдите символ по коду в таблице ASCII.

Расшифруйте коды и введите ключ к следующему заданию.`;
    
    return content;
}

// Задание 4: Комбинация техник (обратный порядок + сдвиг)
function generateTask4File() {
    const key = "KEY_STEG0_4";
    
    // Применяем обратный порядок
    const reversed = key.split('').reverse().join('');
    
    // Затем сдвигаем на 1 позицию вперед (только буквы и цифры)
    let shifted = "";
    for (let char of reversed) {
        if (char === '_') {
            shifted += '_';
        } else if (char >= '0' && char <= '9') {
            shifted += String.fromCharCode(((char.charCodeAt(0) - 48 + 1) % 10) + 48);
        } else if (char >= 'A' && char <= 'Z') {
            shifted += String.fromCharCode(((char.charCodeAt(0) - 65 + 1) % 26) + 65);
        } else {
            shifted += char;
        }
    }
    
    const content = `=== ЗАДАНИЕ 4 ===

Обнаружено сообщение, закодированное комбинацией техник.

Закодированный текст: ${shifted}

Инструкция:
Сообщение было закодировано в два этапа:
1. Сначала строку перевернули (обратный порядок символов)
2. Затем каждый символ сдвинули на 1 позицию вперед в алфавите/цифрах

Пример:
- Исходное: "ABC"
- После переворота: "CBA"  
- После сдвига: "DCB"
- Для расшифровки: сдвинуть назад → "CBA" → перевернуть → "ABC"

Правила сдвига:
- Буквы A-Z: A→B, B→C, ..., Z→A
- Цифры 0-9: 0→1, 1→2, ..., 9→0
- Символ "_" остается без изменений

Подсказка: 
1. Сначала сдвиньте каждый символ на 1 позицию НАЗАД
2. Затем переверните строку (обратный порядок)

Расшифруйте сообщение и введите ключ к следующему заданию.`;
    
    return content;
}

// Задание 5: Финальный флаг (комбинация всех техник)
function generateTask5File() {
    const flag = "FLAG{ST3G4N0GR4PHY_MA5T3R_2024}";
    
    // Применяем несколько преобразований
    // 1. Переворачиваем
    let step1 = flag.split('').reverse().join('');
    
    // 2. Сдвигаем на 2 позиции
    let step2 = "";
    for (let char of step1) {
        if (char === '{' || char === '}') {
            step2 += char;
        } else if (char === '_') {
            step2 += '_';
        } else if (char >= '0' && char <= '9') {
            step2 += String.fromCharCode(((char.charCodeAt(0) - 48 + 2) % 10) + 48);
        } else if (char >= 'A' && char <= 'Z') {
            step2 += String.fromCharCode(((char.charCodeAt(0) - 65 + 2) % 26) + 65);
        } else {
            step2 += char;
        }
    }
    
    // 3. Преобразуем в ASCII коды
    const asciiCodes = [];
    for (let char of step2) {
        asciiCodes.push(char.charCodeAt(0));
    }
    
    const content = `=== ФИНАЛЬНОЕ ЗАДАНИЕ ===

Поздравляем! Вы дошли до финального задания.

Флаг был закодирован в три этапа:
1. Строка была перевернута (обратный порядок)
2. Каждый символ сдвинут на 2 позиции вперед (A→C, B→D, ..., Z→B, 0→2, 1→3, ..., 9→1)
3. Результат преобразован в ASCII коды

ASCII коды (через запятую):
${asciiCodes.join(', ')}

Инструкция по расшифровке:
1. Преобразуйте ASCII коды обратно в символы
2. Сдвиньте каждый символ на 2 позиции НАЗАД
3. Переверните строку (обратный порядок)

Правила:
- Буквы A-Z сдвигаются на 2 назад (C→A, D→B, ..., B→Z)
- Цифры 0-9 сдвигаются на 2 назад (2→0, 3→1, ..., 1→9)
- Символы {, }, _ остаются без изменений

Расшифруйте флаг и введите его в формате FLAG{...}`;
    
    return content;
}

// Функции для генерации изображений и аудио больше не нужны, но оставим заглушки для совместимости
function generateTask2Image() {
    return null; // Не используется
}

function generateTask3AudioAsync() {
    return null; // Не используется
}

function generateTask4Images() {
    return null; // Не используется
}

function generateTask5Archive() {
    return null; // Не используется
}
